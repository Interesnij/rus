
<div id="jquery_jplayer_1" class="jp-jplayer"></div>
<div id="jp_container_1" class="jp-audio">
    <div class="jp-type-playlist">
        <div class="jp-gui jp-interface">
            <ul class="jp-controls">
                <li><label id="name-of-the-song-that-plays"></label></li>
                <li><a href="javascript:;" class="jp-play" tabindex="1">play</a></li>
                <li><a href="javascript:;" class="jp-pause" tabindex="1">pause</a></li>
                <li><a href="javascript:;" class="jp-previous" tabindex="1">previous</a></li>
                <li><a href="javascript:;" class="jp-next" tabindex="1">next</a></li>
                <div class="clear"></div>
            </ul>
            <div class="jp-progress"><div class="jp-seek-bar"><div class="jp-play-bar"></div></div></div>
            <div class="jp-volume-bar"><div class="jp-volume-bar-value"></div></div>
            <div class="jp-time-holder"><div class="jp-current-time"></div></div>
            <div class="clear"></div>
            <ul class="jp-toggles">
                <li><a href="javascript:;" class="jp-shuffle" tabindex="1" title="Перемешать">shuffle</a></li>
                <li><a href="javascript:;" class="jp-shuffle-off" tabindex="1" title="Восстановить порядок">shuffle off</a></li>
                <li></li><li><a href="javascript:;" class="jp-repeat-off" tabindex="1" title="повтор выкл">repeat off</a></li>
            </ul>
            <div class="clear"></div>
        </div>
    </div>
</div>
<div class="jp-playlist">
    <ul style="max-height: 480px;overflow: auto;">
        <li></li>
    </ul>
</div>

<script>

  var ready = (callback) => {
  if (document.readyState != "loading") callback();
  else document.addEventListener("DOMContentLoaded", callback);
  }
  ready(() => {
  var link = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject( 'Microsoft.XMLHTTP' );
  link.open( 'GET', '/music/list/all_tag_list/' + '{{ tag.pk }}', true );
  link.onreadystatechange = function () {
    if ( link.readyState == 4 ) {
        if ( link.status == 200 ) {
            var tag_tracks_load = document.getElementById("tag_tracks_load");
            tag_tracks_load.innerHTML = link.responseText;
            var ajaxElement = document.createElement("div");
            document.querySelector("#tag_tracks_load").appendChild(ajaxElement);
        }
    }
  };
  link.send( null );
  {% if user.is_tag_playlist %}
  playlist_block = document.querySelector(".music-dropdown");
  playlist_block.classList.add('user_{{ user.pk }}');
  {% endif %}

  on('#ajax', 'click', '.track_item', function(e) {
  var tag_playlist = document.querySelector(".tag_playlist");
  var track = tag_playlist.querySelector(".track_item");
  var track_id = track.getAttribute('data-counter');
  var playlist_block = document.querySelector(".music-dropdown");
  var tag_pk = tag_playlist.getAttribute('data-pk');
  if (!playlist_block.classList.contains('tag_' + tag_pk)){
    $.ajax({
      url: "/music/manage/temp_tag/" + tag_pk + "/",
      success: function(data) {
        load_playlist(playlist_block);
        playlist_block.className = "";
        playlist_block.classList.add("dropdown-menu", "music-dropdown", "tag_" + tag_pk);
        setTimeout(function(){ my_playlist_play(track_id)},2000);
      }
    });
  }else{
    my_playlist_play(track_id);
  };
  })
  function load_playlist(playlist_block, callback) {
    var link_playlist = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject( 'Microsoft.XMLHTTP' );
    link_playlist.open( 'GET', '/users/load/playlist/' + '{{ request.user.uuid }}', true );
    link_playlist.onreadystatechange = function () {
      if ( link_playlist.readyState == 4 ) {
          if ( link_playlist.status == 200 ) {
              playlist_block.innerHTML = link_playlist.responseText;
          }
      }
  };
  link_playlist.send( null );
};
function my_playlist_play(track_id) {myPlaylist.play(track_id);};
function my_playlist_stop(track_id) {myPlaylist.pause(track_id);};
});
</script>
