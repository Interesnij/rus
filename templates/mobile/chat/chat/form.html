<script src="/static/scripts/rec.js" type="text/javascript"></script>
<script>
  window.URL = window.URL || window.webkitURL;
  		window.AudioContext = window.AudioContext || window.webkitAudioContext;
  		navigator.getUserMedia  = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
  		var recorder = new RecordVoiceAudios();
  		let startBtn = document.querySelector('#voice_start_btn');
  		let stopBtn = document.querySelector('#message_post_btn');
  		startBtn.onclick = recorder.startRecord;
  		stopBtn.onclick = recorder.stopRecord;

  		function RecordVoiceAudios() {
  			let elementVolume = document.querySelector('.js-volume');
  			let pre = document.querySelector('pre');
  			let encoder = null;
  			let microphone;
  			let isRecording = false;
  			var audioContext;
  			let processor;
  			let config = {
  				bufferLen: 4096,
  				numChannels: 2,
  				mimeType: 'audio/mpeg'
  			};

  			this.startRecord = function() {
  				audioContext = new AudioContext();
  				if (audioContext.createJavaScriptNode) {
  					processor = audioContext.createJavaScriptNode(config.bufferLen, config.numChannels, config.numChannels);
  				} else if (audioContext.createScriptProcessor) {
  					processor = audioContext.createScriptProcessor(config.bufferLen, config.numChannels, config.numChannels);
  				} else {
  					console.log('WebAudio API has no support on this browser.');
  				}

  				processor.connect(audioContext.destination);
  				navigator.mediaDevices.getUserMedia({ audio: true, video: false })
  				.then(gotStreamMethod)
  				.catch(logError);
  			};

  			let getBuffers = (event) => {
  				var buffers = [];
  				for (var ch = 0; ch < 2; ++ch)
  					buffers[ch] = event.inputBuffer.getChannelData(ch);
  				return buffers;
  			}

  			let gotStreamMethod = (stream) => {
  				startBtn.setAttribute('disabled', true);
  				stopBtn.removeAttribute('disabled');
  				config = {
  					bufferLen: 4096,
  					numChannels: 2,
  					mimeType: 'audio/mpeg'
  				};
  				isRecording = true;

  				let tracks = stream.getTracks();
  				microphone = audioContext.createMediaStreamSource(stream);
  				microphone.connect(processor);
  				encoder = new Mp3LameEncoder(audioContext.sampleRate, 160);
  				processor.onaudioprocess = function(event) {
  					encoder.encode(getBuffers(event));
  				};

  				stopBtnRecord = () => {
  					console.log('stopBtnRecord');
  					isRecording = false;
  					startBtn.removeAttribute('disabled');
  					stopBtn.setAttribute('disabled', true);
  					audioContext.close();
  					processor.disconnect();
  					tracks.forEach(track => track.stop());
  				};

  				analizer(audioContext);
  			}

  			this.stopRecord = function() {
  				stopBtnRecord();
  			};

  			let analizer = (context) => {
  				let listener = context.createAnalyser();
  				microphone.connect(listener);
  				listener.fftSize = 256;
  				var bufferLength = listener.frequencyBinCount;
  				let analyserData = new Uint8Array(bufferLength);

  				let getVolume = () => {
  					let volumeSum = 0;
  					let volumeMax = 0;

  					listener.getByteFrequencyData(analyserData);

  					for (let i = 0; i < bufferLength; i++) {
  						volumeSum += analyserData[i];
  					}
  				}

  				getVolume();
  			}

  			let logError = (error) => {
  				alert(error);
  				console.log(error);
  			}
  		}

</script>
<form>
    {% csrf_token %}
    <div class="row files_0"></div>
    <div class="row no-gutters">
      <span class="dropdown message_dropdown" id="dropdown">
        <a class="btn btn-link btn-sm text-secondary drop" style="margin-top: -2px;">
          <svg fill="currentColor" class="svg_info svg_default"  viewBox="0 0 24 24"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>
        </a>
        <div class="dropdown-menu" style="margin-top:-257px;">
            <a class="dropdown-item m_select_photo">Добавить изображение</a>
            <a class="dropdown-item m_select_video">Добавить видеоролик</a>
            <a class="dropdown-item m_select_music">Добавить аудиозапись</a>
            <a class="dropdown-item m_select_article">Добавить статью</a>
            <a class="dropdown-item m_select_good">Добавить товар</a>
            <a class="dropdown-item m_select_doc">Добавить документ</a>
        </div>
      </span>
        <div class="col">
            <div class="input-group input-group-sm">
              <input type="text" name="text" class="text form-control text-comment form-control-rounded">
            </div>
        </div>
        <div class="col-auto">
            <a class="btn btn-link btn-sm text-secondary" id="voice_start_btn" type="button">
              <svg class="svg_default svg_info" fill="currentColor" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 15c1.66 0 2.99-1.34 2.99-3L15 6c0-1.66-1.34-3-3-3S9 4.34 9 6v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 15 6.7 12H5c0 3.42 2.72 6.23 6 6.72V22h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/></svg>
            </a>
            <a class="btn btn-link btn-sm text-secondary" id="message_post_btn" type="button">
              <svg class="svg_default svg_info" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/><path d="M0 0h24v24H0z" fill="none"/></svg>
            </a>
        </div>
    </div>
</form>
