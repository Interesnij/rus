<script>

    let audioIN = { audio: true };
    //  audio is true, for recording

    // Access the permission for use
    // the microphone
    navigator.mediaDevices.getUserMedia(audioIN)

      // 'then()' method returns a Promise
      .then(function (mediaStreamObj) {

        // Connect the media stream to the
        // first audio element
        let audio = document.querySelector('audio');
        //returns the recorded audio via 'audio' tag

        // 'srcObject' is a property which
        // takes the media object
        // This is supported in the newer browsers
        if ("srcObject" in audio) {
          audio.srcObject = mediaStreamObj;
        }
        else {   // Old version
          audio.src = window.URL
            .createObjectURL(mediaStreamObj);
        }

        // It will play the audio
        audio.onloadedmetadata = function (ev) {

          // Play the audio in the 2nd audio
          // element what is being recorded
          audio.play();
        };

        // Start record
        let start = document.getElementById('btnStart');

        // Stop record
        let stop = document.getElementById('btnStop');

        // 2nd audio tag for play the audio
        let playAudio = document.getElementById('adioPlay');

        // This is the main thing to recorde
        // the audio 'MediaRecorder' API
        let mediaRecorder = new MediaRecorder(mediaStreamObj);
        // Pass the audio stream

        // Start event
        start.addEventListener('click', function (ev) {
          mediaRecorder.start();
          // console.log(mediaRecorder.state);
        })

        // Stop event
        stop.addEventListener('click', function (ev) {
          mediaRecorder.stop();
          // console.log(mediaRecorder.state);
        });

        // If audio data available then push
        // it to the chunk array
        mediaRecorder.ondataavailable = function (ev) {
          dataArray.push(ev.data);
        }

        // Chunk array to store the audio data
        let dataArray = [];

        // Convert the audio data in to blob
        // after stopping the recording
        mediaRecorder.onstop = function (ev) {

          // blob of type mp3
          let audioData = new Blob(dataArray,
                    { 'type': 'audio/mp3;' });

          // After fill up the chunk
          // array make it empty
          dataArray = [];

          // Creating audio url with reference
          // of created blob named 'audioData'
          let audioSrc = window.URL
              .createObjectURL(audioData);

          // Pass the audio url to the 2nd video tag
          playAudio.src = audioSrc;
        }
      })

      // If any error occurs then handles the error
      .catch(function (err) {
        console.log(err.name, err.message);
      });
  </script>

  <button id="btnStart">START RECORDING</button>

    <button id="btnStop">STOP RECORDING</button>
    <!--button for 'stop recording'-->

  <!--for record-->
  <audio controls></audio>
  <!--'controls' use for add
    play, pause, and volume-->

  <!--for play the audio-->
  <audio id="adioPlay" controls></audio>

<form>
    {% csrf_token %}
    <div class="row files_0"></div>
    <div class="row no-gutters">
      <span class="dropdown message_dropdown" id="dropdown">
        <a class="btn btn-link btn-sm text-secondary drop" style="margin-top: -2px;">
          <svg fill="currentColor" class="svg_info svg_default"  viewBox="0 0 24 24"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>
        </a>
        <div class="dropdown-menu" style="margin-top:-257px;">
            <a class="dropdown-item m_select_photo">Добавить изображение</a>
            <a class="dropdown-item m_select_video">Добавить видеоролик</a>
            <a class="dropdown-item m_select_music">Добавить аудиозапись</a>
            <a class="dropdown-item m_select_article">Добавить статью</a>
            <a class="dropdown-item m_select_good">Добавить товар</a>
            <a class="dropdown-item m_select_doc">Добавить документ</a>
        </div>
      </span>
        <div class="col">
            <div class="input-group input-group-sm">
              <input type="text" name="text" class="text form-control text-comment form-control-rounded">
            </div>
        </div>
        <div class="col-auto">
            <a class="btn btn-link btn-sm text-secondary" id="voice_start_btn" type="button">
              <svg class="svg_default svg_info" fill="currentColor" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 15c1.66 0 2.99-1.34 2.99-3L15 6c0-1.66-1.34-3-3-3S9 4.34 9 6v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 15 6.7 12H5c0 3.42 2.72 6.23 6 6.72V22h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/></svg>
            </a>
            <a class="btn btn-link btn-sm text-secondary" id="message_post_btn" style="display:none" type="button">
              <svg class="svg_default svg_info" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/><path d="M0 0h24v24H0z" fill="none"/></svg>
            </a>
        </div>
    </div>
</form>
