{% load staticfiles %}
<!doctype html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>{% block title %}{% endblock %}</title>
    {% block meta %}{% endblock %}
    <link rel="shortcut icon" href="{% static 'images/favicon.ico' %}" ; type="image/x-icon" />
    <link rel="icon" href="{% static 'images/favicon.ico' %}" ; type="image/x-icon" />
    <link rel="stylesheet" href="{% static 'styles/material-icons.css' %}" media="none" onload="if(media!='all')media='all'" />
    <link rel="stylesheet" href="{% static 'styles/bootstrap.min.css' %}" />
    <link rel="stylesheet" href="{% static 'styles/animate.css' %}" />
    <link rel="stylesheet" href="{% static 'styles/swiper.min.css' %}" />
    <link rel="stylesheet" href="{% static 'styles/default-skin.css' %}" />
    <link rel="stylesheet" href="{% static 'styles/photoswipe.css' %}" />
    <link rel="stylesheet" href="{% static 'styles/bootstrap-tour-standalone.css' %}" />
    <link rel="stylesheet" href="{% static 'styles/color/purplesidebar.css' %}" media="all" />
    <script src="{% static 'scripts/jquery-3.2.1.min.js' %}" type="text/javascript"></script>
</head>
<style>
@media screen and (max-width: 620px) {
   .gadget-only{
    display: none;
  }
}
a {
  color: inherit;
}
</style>
<body class="fixed-header sidebar-right-close sidebar-left-close">
    <div class="wrapper">
        {% include "generic/messages.html" %}
        {% include "base_block/navbar.html" %}

        <span class="d-sm-none d-block">
            {% include "base_block/sidebar_left.html" %}

            {% include "base_block/sidebar_right.html" %}
        </span>

        <div class="jambotron-fluid">
							<span class="container col-12 col-md-12 main-container d-none " style="display:flex !important;flex-wrap: wrap;">

								 <div class="col-md-2 gadget-only">
 									 {% include 'base_block/decstop_nav.html' %}
 								 </div>

							  <div class="col-md-8" id="ajax">
                	{% block content %}
                	{% endblock %}
								</div>

								<div class="col-md-2 gadget-only">
								</div>

							</span>

                {% include "base_scripts.html" %}
        </div>
    </div>

    {% include "base_block/footer.html" %}


    <script>
        "use script";
        $(window).on('load', function() {
            var tour = new Tour({
                steps: [{
                    element: "#left-menu",
                    title: "Main Menu",
                    content: "Access the demo pages from sidebar",
                    smartPlacement: true,
                    storage: false
                }, {
                    element: "button[data-target='#createOrder']",
                    title: "Creative Form",
                    content: "See beautifully designed form in modal",
                    smartPlacement: true,
                    placement: "left",
                    storage: false
                }, {
                    element: ".close-sidebar",
                    title: "Customizaton Menu",
                    content: "Customize your Layout style",
                    smartPlacement: true,
                    placement: "left",
                    storage: false
                }]
            });
            tour.init();
            tour.start();
        });
    </script>
    <script>
        'use strict';
        var mySwiper = new Swiper('.swiper-signin', {
            slidesPerView: 1,
            spaceBetween: 0,
            autoplay: true,
            pagination: {
                el: '.swiper-pagination',
                clickable: true,
            }
        });

        $(window).on('resize', function() {
            var mySwiper = new Swiper('.swiper-signin', {
                slidesPerView: 1,
                spaceBetween: 0,
                autoplay: true,
                pagination: {
                    el: '.swiper-pagination',
                    clickable: true,
                }
            });
        });
    </script>
    <script>
    $(function () {
    let emptyMessage = 'You have no unread notification';

    function checkNotifications() {
        $.ajax({
            url: '/notifications/latest-notifications/',
            cache: false,
            success: function (data) {
                if (!data.includes(emptyMessage)) {
                    $("#notifications").addClass("btn-danger");
                }
            },
        });
    };

    function update_social_activity (id_value) {
        let newsToUpdate = $("[news-id=" + id_value + "]");
        payload = {
            'id_value': id_value,
        };
        $.ajax({
            url: '/news/update-interactions/',
            data: payload,
            type: 'POST',
            cache: false,
            success: function (data) {
                $(".like-count", newsToUpdate).text(data.likes);
                $(".comment-count", newsToUpdate).text(data.comments);
            },
        });
    };


    $('#notifications').popover({
        html: true,
        trigger: 'manual',
        container: "body" ,
        placement: "bottom",
    });

    $("#notifications").click(function () {
        if ($(".popover").is(":visible")) {
            $("#notifications").popover('hide');
            checkNotifications();
        }
        else {
            $("#notifications").popover('dispose');
            $.ajax({
                url: '/notifications/latest-notifications/',
                cache: false,
                success: function (data) {
                    $("#notifications").popover({
                        html: true,
                        trigger: 'focus',
                        container: "body" ,
                        placement: "bottom",
                        content: data,
                    });
                    $("#notifications").popover('show');
                    $("#notifications").removeClass("btn-danger")
                },
            });
        }
        return false;
    });

    // Блок кода для управления подключениями WebSocket
    // Попробуйте правильно выбрать между ws: / / и wss://
    let ws_scheme = window.location.protocol == "http:" ? "wss" : "ws";
    let ws_path2 = ws_scheme + '://' + window.location.host + "/notifications/";
    let ws_path = 'ws://151.248.115.197:9090/';
    let webSocket = new channels.WebSocketBridge();
    webSocket.connect(ws_path);

    // Helpful debugging
    webSocket.socket.onopen = function () {
        console.log("Connected to " + ws_path);
    };

    webSocket.socket.onclose = function () {
        console.error("Disconnected from " + ws_path);
    };

    // Слушайте мост WebSocket, созданный через библиотеку django-channels.
    webSocket.listen(function(event) {
        switch (event.key) {
            case "notification":
                $("#notifications").addClass("btn-danger");
                break;

            case "social_update":
                $("#notifications").addClass("btn-danger");
                update_social_activity(event.id_value);
                break;

            case "additional_news":
                if (event.actor_name !== currentUser) {
                    $(".stream-update").show();
                }
                break;

            default:
                console.log('error: ', event);
                break;
        };
    });
});
    </script>
</body>

</html>
