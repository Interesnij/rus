{% load humanize staticfiles liked_user %}
<script src="{% static 'scripts/jquery-3.2.1.min.js' %}" type="text/javascript"></script>

<span class="stream_comments">
    {% for comment in comments %}
    <div></div>
    <div class="media pt-2" comment-id="{{ comment.id }}">
        <figure>
            {% if comment.commenter.profile.avatar %}
              <img src="{{ comment.commenter.profile.avatar.url }}" class="pull-left" style="border-radius:50%;width:30px;" alt="User Image" class="user-image">
            {% else %}
              <img src="{% static 'images/user.png' %}" class="pull-left" style="border-radius:50%;width:30px;" alt="No Profile Picture" />
            {% endif %}
        </figure>
        <div class="media-body">
            <h5 class="mt-0">{{ comment.commenter.get_full_name }}
                <small class="text-muted float-right">{{ comment.created|naturaltime }}</small>
            </h5>
            <p class="mb-2">{{ comment.text|safe }}</p>

            <div class="card-footer border-top py-2">
                <div class="row" style="color: rgba(255, 255, 255, 0.65);">
                    <div class="col">
                        <span class="like2 content-color-secondary{% if comment.votes.likes.all|user_in:request.user %} text-success {% endif %}"
                              style="font-size:13px;cursor:pointer"
                              id="like2"
                              data-id="{{ comment.id }}"
                              data-action="like2"
                              data-type="comment">
                            <i class="material-icons">thumb_up</i>&nbsp;
                            <span data-count="like">
                              {% if comment.votes.likes.count != 0 %}{{ comment.votes.likes.count }}{% endif %}
                            </span>
                        </span>

                        <span class="comment_like_window">
                            {% if comment.votes.likes.all %}
                            <div class="like_pop" style="margin:15px">
                                <span>Лайков: {{ comment.votes.likes.count }}</span>
                                <br><br>
                                <span style="display: flex;">
                                    {% for heart in comment.votes.likes.all %}
                                    <a href="{% url 'user' pk=heart.user.pk %}" style="padding-right:10px">
                                        <figure style="margin: 0;">
                                            {% if heart.user.profile.avatar %}
                                            <img src="{{ heart.user.profile.avatar.url }}" style="border-radius: 50px;width:50px;" alt="image">
                                            {% else %}
                                            <img src="{% static 'images/user.png' %}" alt="image" style="border-radius: 50px;width:50px;">
                                            {% endif %}
                                        </figure>
                                        {{ heart.user.first_name }}
                                    </a>
                                    {% endfor %}
                                </span>
                            </div>
                            {% endif %}
                        </span>

                        &nbsp;&nbsp;
                        <span class="dislike2 content-color-secondary{% if comment.votes.dislikes.all|user_in:request.user %} text-danger {% endif %}"
                              style="font-size:13px;cursor:pointer"
                              id="dislike2"
                              data-id="{{ comment.id }}"
                              data-action="dislike2"
                              data-type="comment">
                            <i class="material-icons">thumb_down</i>&nbsp;
                            <span data-count="dislike">
                              {% if comment.votes.dislikes.count %}{{ comment.votes.dislikes.count }}{% endif %}
                            </span>
                        </span>

                        <span class="comment_dislike_window">
                            {% if comment.votes.dislikes.all %}
                            <div class="dislike_pop" style="margin:15px">
                                <span>Дизлайков: {{ comment.votes.dislikes.count }}</span>
                                <br><br>
                                <span style="display: flex;">
                                    {% for sheet in comment.votes.dislikes.all %}
                                    <a href="{% url 'user' pk=sheet.user.pk %}" style="padding-right:10px">
                                        <figure style="margin: 0;">
                                            {% if sheet.user.profile.avatar %}
                                            <img src="{{ sheet.user.profile.avatar.url }}" style="border-radius: 50px;width:50px;" alt="image">
                                            {% else %}
                                            <img src="{% static 'images/user.png' %}" alt="image" style="border-radius: 50px;width:50px;">
                                            {% endif %}

                                        </figure>
                                        {{ sheet.user.first_name }}
                                    </a>
                                    {% endfor %}
                                </span>
                            </div>
                            {% endif %}
                        </span>

                        &nbsp;&nbsp;
                        <span class="content-color-secondary comment" style="font-size:15px;cursor:pointer">
                            ответить
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {% endfor %}
</span>

<div class="card-footer border-top" style="margin-top:10px">
    <form action="" id="replyPostForm" method="post">
        {% csrf_token %}
        <div class="row no-gutters">

            <input type="hidden" name="parent" value="{{ parent.pk }}">
            <div class="col">
                <div class="input-group input-group-sm">
                    <div class="input-group-prepend">
                        <button class="btn btn-link content-color-secondary" type="button"><i class="material-icons">face</i></button>
                        <button class="btn btn-link content-color-secondary text-hide-xs" type="button"><i class="material-icons">collections</i></button>
                    </div>
                    <textarea id="id_text" name="text" class="form-control form-control-rounded"></textarea>
                </div>
            </div>
            <div class="col-auto">
                <button class="btn btn-outline-primary btn-rounded btn-sm ml-2" id="replyPost" type="button">
                    <i class="material-icons">send</i>
                </button>
            </div>
        </div>
    </form>
</div>

<script src="/static/scripts/jquery.toast.min.js" type="text/javascript"></script>
<script>
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };

    function csrfSafeMethod(method) {
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    var csrftoken = getCookie('csrftoken');
    var page_title = $(document).attr("title");
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    $("#replyPost").click(function() {
        $.ajax({
            url: '/posts/post-comment/',
            data: $("#replyPostForm").serialize(),
            type: 'POST',
            cache: false,
            success: function(data) {
                $("#id_text").val("");
                $(".stream_comments").append(data);
            },
            error: function(data) {
                alert(data.responseText);
            },
        });
        return false;
    });
</script>
<script>
    function like2() {
        var like = $(this);
        var type = like.data('type');
        var pk = like.data('id');
        var action = like.data('action');
        var dislike = like.next();
        $.ajax({
            url: "/posts/comment/" + pk + "/like/",
            type: 'POST',
            data: {
                'obj': pk
            },
            success: function(json) {
                like.find("[data-count='like']").text(json.like_count);
                dislike.find("[data-count='dislike']").text(json.dislike_count);
                like.addClass("text-success");
                dislike.removeClass("text-danger");
            }
        });
        return false;
    }
    function dislike2() {
        var dislike = $(this);
        var type = dislike.data('type');
        var pk = dislike.data('id');
        var action = dislike.data('action');
        var like = dislike.prev();
        $.ajax({
            url: "/posts/comment/" + pk + "/dislike/",
            type: 'POST',
            data: {
                'obj': pk
            },
            success: function(json) {
                dislike.find("[data-count='dislike']").text(json.dislike_count);
                like.find("[data-count='like']").text(json.like_count);
                dislike.addClass("text-danger");
                like.removeClass("text-success");
            }
        });
        return false;
    }
    // Подключение обработчиков
    $('[data-action="like2"]').click(like2);
    $('[data-action="dislike2"]').click(dislike2);
</script>
