{% load staticfiles %}

<script src="{% static 'scripts/popper.min.js' %}" type="text/javascript"></script>
<script src="{% static 'scripts/bootstrap.min.js' %}" type="text/javascript"></script>
<script src="{% static 'scripts/swiper.min.js' %}" type="text/javascript"></script>
<script src="{% static 'scripts/photoswipe.min.js' %}" type="text/javascript"></script>
<script src="{% static 'scripts/photoswipe-ui-default.min.js' %}" type="text/javascript"></script>
<script src="{% static 'scripts/photoswipesctipt.js' %}" type="text/javascript"></script>
<script src="{% static 'scripts/masonry.pkgd.min.js' %}" type="text/javascript"></script>
<script src="{% static 'scripts/websocketbridge.js' %}" type="text/javascript"></script>
<script src="{% static 'scripts/jquery.cookie.js' %}" type="text/javascript"></script>
<script src="{% static 'scripts/main.js' %}" type="text/javascript"></script>

<script>
    'use strict';
    var mySwiper = new Swiper('.swiper-signin', {
        slidesPerView: 1,
        spaceBetween: 0,
        autoplay: true,
        pagination: {
            el: '.swiper-pagination',
            clickable: true,
        }
    });
    $(window).on('resize', function() {
        var mySwiper = new Swiper('.swiper-signin', {
            slidesPerView: 1,
            spaceBetween: 0,
            autoplay: true,
            pagination: {
                el: '.swiper-pagination',
                clickable: true,
            }
        });
    });
</script>

{% if request.user.is_authenticated %}
<script>
$(function () {
let emptyMessage = 'You have no unread notification';
function checkNotifications() {
    $.ajax({
        url: '/notifications/latest-notifications/',
        cache: false,
        success: function (data) {
            if (!data.includes(emptyMessage)) {
                $("#dropdownnotification").addClass("btn-danger");
            }
        },
    });
};
function update_social_activity (id_value) {
    let postToUpdate = $("[post-id=" + id_value + "]");
    payload = {
        'id_value': id_value,
    };
    $.ajax({
        url: 'ws://xn--b1afgj5al1e.xn--p1acf:8001/posts/update-interactions/',
        data: payload,
        type: 'POST',
        cache: false,
        success: function (data) {
            $(".like-count", postToUpdate).text(data.likes);
            $(".dislike-count", postToUpdate).text(data.dislikes);
            $(".comment-count", postToUpdate).text(data.comments);
        },
    });
};
checkNotifications();
$('#dropdownnotification').popover({
    html: true,
    trigger: 'manual',
    container: "body" ,
    placement: "bottom",
});
$("#dropdownnotification").click(function () {
    if ($(".popover").is(":visible")) {
        $("#dropdownnotification").popover('hide');
        checkNotifications();
    }
    else {
        $("#dropdownnotification").popover('dispose');
        $.ajax({
            url: '/notifications/latest-notifications/',
            cache: false,
            success: function (data) {
                $("#dropdownnotification").popover({
                    html: true,
                    trigger: 'focus',
                    container: "body" ,
                    placement: "bottom",
                    content: data,
                });
                $("#dropdownnotification").popover('show');
                $("#dropdownnotification").removeClass("btn-danger")
            },
        });
    }
    return false;
});
let ws_path = "ws://xn--b1afgj5al1e.xn--p1acf:8001/notifications/";
let webSocket = new channels.WebSocketBridge();
webSocket.connect(ws_path);
// Helpful debugging
webSocket.socket.onopen = function () {
    console.log("Connected to " + ws_path);
};
webSocket.socket.onclose = function () {
    console.error("Disconnected from " + ws_path);
};

webSocket.listen(function(event) {
    switch (event.key) {
        case "notification":
            $("#notification").addClass("btn-danger");
            break;
        case "social_update":
            $("#notification").addClass("btn-danger");
            update_social_activity(event.id_value);
            break;
        case "additional_post":
            if (event.actor_name !== currentUser) {
                $(".stream-update").show();
            }
            break;
        default:
            console.log('error: ', event);
            break;
    };
});
});
</script>
{% endif %}
<script type="text/javascript">
          var currentUser = "{{ request.user.username }}"
        </script>
