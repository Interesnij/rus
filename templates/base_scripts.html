{% load staticfiles %}

<script src="{% static 'scripts/popper.min.js' %}" type="text/javascript"></script>
<script src="{% static 'scripts/bootstrap.min.js' %}" type="text/javascript"></script>
<script src="{% static 'scripts/swiper.min.js' %}" type="text/javascript"></script>
<script src="{% static 'scripts/photoswipe.min.js' %}" type="text/javascript"></script>
<script src="{% static 'scripts/photoswipe-ui-default.min.js' %}" type="text/javascript"></script>
<script src="{% static 'scripts/photoswipesctipt.js' %}" type="text/javascript"></script>
<script src="{% static 'scripts/masonry.pkgd.min.js' %}" type="text/javascript"></script>
<script src="{% static 'scripts/bootstrap-tour-standalone.min.js' %}" type="text/javascript"></script>
<script src="{% static 'scripts/websocketbridge.js' %}" type="text/javascript"></script>
<script src="{% static 'scripts/jquery.cookie.js' %}" type="text/javascript"></script>
<script src="{% static 'scripts/main.js' %}" type="text/javascript"></script>
<script src="{% static 'scripts/dashboard-social.js' %}" type="text/javascript"></script>

<script>
    "use script";
    $(window).on('load', function() {
        var tour = new Tour({
            steps: [{
                element: "#left-menu",
                title: "Main Menu",
                content: "Access the demo pages from sidebar",
                smartPlacement: true,
                storage: false
            }, {
                element: "button[data-target='#createOrder']",
                title: "Creative Form",
                content: "See beautifully designed form in modal",
                smartPlacement: true,
                placement: "left",
                storage: false
            }, {
                element: ".close-sidebar",
                title: "Customizaton Menu",
                content: "Customize your Layout style",
                smartPlacement: true,
                placement: "left",
                storage: false
            }]
        });
        tour.init();
        tour.start();
    });
</script>
<script>
    'use strict';
    var mySwiper = new Swiper('.swiper-signin', {
        slidesPerView: 1,
        spaceBetween: 0,
        autoplay: true,
        pagination: {
            el: '.swiper-pagination',
            clickable: true,
        }
    });
    $(window).on('resize', function() {
        var mySwiper = new Swiper('.swiper-signin', {
            slidesPerView: 1,
            spaceBetween: 0,
            autoplay: true,
            pagination: {
                el: '.swiper-pagination',
                clickable: true,
            }
        });
    });
</script>

{% if request.user.is_authenticated %}
<script>
$(function () {
let emptyMessage = 'You have no unread notification';
function checkNotifications() {
    $.ajax({
        url: '/notifications/latest-notifications/',
        cache: false,
        success: function (data) {
            if (!data.includes(emptyMessage)) {
                $("#notifications").addClass("btn-danger");
            }
        },
    });
};
function update_social_activity (id_value) {
    let newsToUpdate = $("[post-id=" + id_value + "]");
    payload = {
        'id_value': id_value,
    };
    $.ajax({
        url: '/posts/update-interactions/',
        data: payload,
        type: 'POST',
        cache: false,
        success: function (data) {
            $(".like-count", newsToUpdate).text(data.likes);
            $(".comment-count", newsToUpdate).text(data.comments);
        },
    });
};
checkNotifications();
$('#notifications').popover({
    html: true,
    trigger: 'manual',
    container: "body" ,
    placement: "bottom",
});
$("#notifications").click(function () {
    if ($(".popover").is(":visible")) {
        $("#notifications").popover('hide');
        checkNotifications();
    }
    else {
        $("#notifications").popover('dispose');
        $.ajax({
            url: '/notifications/latest-notifications/',
            cache: false,
            success: function (data) {
                $("#notifications").popover({
                    html: true,
                    trigger: 'focus',
                    container: "body" ,
                    placement: "bottom",
                    content: data,
                });
                $("#notifications").popover('show');
                $("#notifications").removeClass("btn-danger")
            },
        });
    }
    return false;
});
let ws_path = "ws://xn--b1afgj5al1e.xn--p1acf:8001/notifications/";
let webSocket = new channels.WebSocketBridge();
webSocket.connect(ws_path);
// Helpful debugging
webSocket.socket.onopen = function () {
    console.log("Connected to " + ws_path);
};
webSocket.socket.onclose = function () {
    console.error("Disconnected from " + ws_path);
};

webSocket.listen(function(event) {
    switch (event.key) {
        case "notification":
            $("#notifications").addClass("btn-danger");
            break;
        case "social_update":
            $("#notifications").addClass("btn-danger");
            update_social_activity(event.id_value);
            break;
        case "additional_post":
            if (event.actor_name !== currentUser {
                $(".stream-update").show();
            }
            break;
        default:
            console.log('error: ', event);
            break;
    };
});
});
</script>
{% endif %}
