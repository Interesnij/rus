{% load staticfiles humanize liked_user %}

{% if object.post %}
<div class="card mb-4 infinite-item" post-id="{{ object.post.uuid }}" style="cursor:pointer">
    <div class="card-header border-bottom">
        <div class="media">
            <figure>
              {% if object.creator.profile.avatar %}
                <img src="{{ object.creator.profile.avatar.url }}" style="border-radius: 50px;width:50px;" alt="image">
              {% else %}
                <img src="{% static 'images/user.png' %}" style="border-radius: 50px;width:50px;" alt="image">
              {% endif %}
            </figure>
            <div class="media-body">
                <h6 class="mb-0">{{ object.creator.get_full_name }}</h6>
                <p class="mb-0">{{ object.created|naturaltime }}</p>
            </div>
            <div class="dropdown d-inline-block" style="margin-right: 20px;">

                <a style="cursor:pointer" class="icon-circle icon-30 dropdown-toggle caret-none" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="material-icons ">more_vertical</i>
                </a>

                <div class="dropdown-menu dropdown-menu-right">
                  {% if user == request.user and request.user.is_authenticated %}
                    <span data-action="post_remove" data-id="{{ object.pk }}" data-type="Пост" style="cursor:pointer" class="dropdown-item post_remove">Удалить запись</span>
                    <a href="#" id="post_update" class="dropdown-item">Редактировать</a>
                    <a href="#" id="post_up" class="dropdown-item">Закрепить</a>
                    <a href="#" id="post_check_comment" class="dropdown-item">Выключить комментарии</a>
                  {% else %}
                    <a href="#" id="post_bad" class="dropdown-item">Пожаловаться</a>
                  {% endif %}
                </div>

            </div>
            <span class="activefullscreen_hide">Х</span>
        </div>
    </div>
    <div class="card-body fullscreen" data-id="{{ object.pk }}" style="cursor:pointer">
      {% if object.post.text %}
        <p class="">{{ object.post.text|safe }}</p>
      {% endif %}
      {% if object.post.image %}
        <p class="">{{ object.post.image.url }}</p>
      {% endif %}
      {% if object.post.doc %}
        <p class="">{{ object.post.doc }}</p>
      {% endif %}
    </div>

    {% include 'generic/post_info.html' %}

</div>

<script src="/static/scripts/cockie.js" type="text/javascript"></script>
<script>
	function post_like() {
			var like = $(this);
			var post = $('.infinite-item').attr("post-id");
			var type = like.data('type');
			var pk = like.data('id');
			var action  = like.data('action');
			var dislike = like.next().next();
			payload = {
					'post': post,
					'csrf_token': csrftoken
				}
			$.ajax({
					url: "/posts/like/" + pk + "/",
					type: 'POST',
					cache: false,
					data: payload,
					success: function(data) {
							like.find("[data-count='like']").text(data.like_count);
							dislike.find("[data-count='dislike']").text(data.dislike_count);
							$(like).addClass("text-success");
							$(dislike).removeClass("text-danger");
							$(like).siblings('.like_window').html('').load("/posts/like_window/" + pk + "/");
							$(dislike).siblings('.dislike_window').html('').load("/posts/dislike_window/" + pk + "/")
					}
			});
			return false;
	}
	function post_dislike() {
			var dislike = $(this);
			var post = $('.infinite-item').attr("posts-id");
			var type = dislike.data('type');
			var pk = dislike.data('id');
			var action = dislike.data('action');
			var like = dislike.prev().prev();
			payload = {
					'post': post,
					'csrf_token': csrftoken
				}
			$.ajax({
					url: "/posts/dislike/" + pk + "/",
					type: 'POST',
					cache: false,
					data: payload,
					success: function(data) {
							dislike.find("[data-count='dislike']").text(data.dislike_count);
							like.find("[data-count='like']").text(data.like_count);
							$(dislike).addClass("text-danger");
							$(like).removeClass("text-success");
							$(like).siblings('.like_window').html('').load("/posts/like_window/" + pk + "/");
							$(dislike).siblings('.dislike_window').html('').load("/posts/dislike_window/" + pk + "/")
					}
			});
			return false;
	}
	// Подключение обработчиков
	$('[data-action="post_like"]').click(post_like);
	$('[data-action="post_dislike"]').click(post_dislike);
</script>

<script>
$(".post_comment").on("click", function () {
	var post = $(this).closest(".infinite-item").attr("post-id");
	var url = $(this).parents(".infinite-item");
	$.ajax({
			url: '{% url "post_get_comment" %}',
			data: {'post': post},
			cache: false,
			beforeSend: function () {
					url.find(".load_comments").html("<span style='display:flex;justify-content: center;'><img src='/static/images/loading.gif'></span>");
			},
			success: function (data) {
				url.find(".load_comments").html(data.comments);
			}
	});
	return false;
});
</script>

<script>
function remove() {
var remove = $(this);
var pk = remove.data('id');
$.ajax({
	url: "/posts/delete/" + pk + "/",
	success: function (data) {
		$(remove).parents('.card').hide();
		$.toast({
				heading: '{{ request.user.first_name }}',
				text: 'Запись успешно удалена!',
				showHideTransition: 'fade',
				icon: 'error'
		})
	},
	error: function(data) {
	}
});
};
$('[data-action="post_remove"]').click(remove);
</script>
{% endif %}

{% if object.article %}
<div class="card mb-4 infinite-item" article-id="{{ object.article.uuid }}">
    <div class="card-header border-bottom">
        <div class="media">
            <figure>
              {% if object.creator.profile.avatar %}
                <img src="{{ object.creator.profile.avatar.url }}" style="border-radius: 50px;width:50px;" alt="image">
              {% else %}
                <img src="{% static 'images/user.png' %}" style="border-radius: 50px;width:50px;" alt="image">
              {% endif %}
            </figure>
            <div class="media-body">
                <h6 class="mb-0">{{ object.creator.first_name }} {{ object.creator.last_name }}</h6>
                <p class="mb-0">{{ object.created|naturaltime }}</p>
            </div>
            <div class="dropdown d-inline-block" style="margin-right: 20px;">
                <a style="cursor:pointer" class="icon-circle icon-30 dropdown-toggle caret-none" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="material-icons ">more_vertical</i>
                </a>

                <div class="dropdown-menu dropdown-menu-right">
                  {% if user == request.user and request.user.is_authenticated %}
                    <span data-action="remove" data-id="{{ object.pk }}" data-type="Пост" style="cursor:pointer" class="dropdown-item post_remove">Удалить запись</span>
                    <a href="#" id="article_update" class="dropdown-item">Редактировать</a>
                    <a href="#" id="article_up" class="dropdown-item">Закрепить</a>
                    <a href="#" id="article_check_comment" class="dropdown-item">Выключить комментарии</a>
                  {% else %}
                    <a href="#" id="article_bad" class="dropdown-item">Пожаловаться</a>
                  {% endif %}
                </div>
            </div>
            <span class="activefullscreen_hide">Х</span>
        </div>
    </div>
    <div class="card-body fullscreen" data-id="{{ object.pk }}" style="cursor:pointer">
      {% if object.article.content_hard %}
        <p class="mb-0 content-color-secondary">{{ object.article.content_hard|safe }}</p>
      {% endif %}
      {% if object.article.content_medium %}
        <p class="mb-0 content-color-secondary">{{ object.article.content_medium|safe }}</p>
      {% endif %}
      {% if object.article.content_lite %}
        <p class="mb-0 content-color-secondary">{{ object.article.content_lite|safe }}</p>
      {% endif %}
    </div>

    {% include 'generic/article_info.html' %}

</div>

<script src="/static/scripts/cockie.js" type="text/javascript"></script>
<script>
	function art_like() {
			var like = $(this);
			var article = $('.infinite-item').attr("article-id");
			var type = like.data('type');
			var pk = like.data('id');
			var action  = like.data('action');
			var dislike = like.next().next();
			payload = {
					'article': article,
					'csrf_token': csrftoken
				}
			$.ajax({
					url: "/article/like/" + pk + "/",
					type: 'POST',
					cache: false,
					data: payload,
					success: function(data) {
							like.find("[data-count='like']").text(data.like_count);
							dislike.find("[data-count='dislike']").text(data.dislike_count);
							$(like).addClass("text-success");
							$(dislike).removeClass("text-danger");
							$(like).siblings('.like_window').html('').load("/article/like_window/" + pk + "/");
							$(dislike).siblings('.dislike_window').html('').load("/article/dislike_window/" + pk + "/")
					}
			});
			return false;
	}
	function art_dislike() {
			var dislike = $(this);
			var article = $('.infinite-item').attr("article-id");
			var type = dislike.data('type');
			var pk = dislike.data('id');
			var action = dislike.data('action');
			var like = dislike.prev().prev();
			payload = {
					'article': article,
					'csrf_token': csrftoken
				}
			$.ajax({
					url: "/article/dislike/" + pk + "/",
					type: 'POST',
					cache: false,
					data: payload,
					success: function(data) {
							dislike.find("[data-count='dislike']").text(data.dislike_count);
							like.find("[data-count='like']").text(data.like_count);
							$(dislike).addClass("text-danger");
							$(like).removeClass("text-success");
							$(like).siblings('.like_window').html('').load("/article/like_window/" + pk + "/");
							$(dislike).siblings('.dislike_window').html('').load("/article/dislike_window/" + pk + "/")
					}
			});
			return false;
	}
	// Подключение обработчиков
	$('[data-action="art_like"]').click(art_like);
	$('[data-action="art_dislike"]').click(art_dislike);
</script>

<script>
$(".art_comment").on("click", function () {
	var article = $(this).closest(".infinite-item").attr("article-id");
	var url = $(this).parents(".infinite-item");
	$.ajax({
			url: '{% url "article_get_comment" %}',
			data: {'article': article},
			cache: false,
			beforeSend: function () {
					url.find(".load_comments").html("<span style='display:flex;justify-content: center;'><img src='/static/images/loading.gif'></span>");
			},
			success: function (data) {
				url.find(".load_comments").html(data.comments);
			}
	});
	return false;
});
</script>

<script>
function remove() {
var remove = $(this);
var pk = remove.data('id');
$.ajax({
	url: "/article/delete/" + pk + "/",
	success: function (data) {
		$(remove).parents('.card').hide();
    $('.activefullscreen').hide();
		$.toast({
				heading: '{{ request.user.first_name }}',
				text: 'статья успешно удалена!',
				showHideTransition: 'fade',
				icon: 'error'
		})
	},
	error: function(data) {
	}
});
};
$('[data-action="article_remove"]').click(remove);
</script>

{% endif %}

<div class="">
  {% if object.get_previous_by_created %}
    <span class="prev_item">
      <img scr="{% static 'images/icons/left-24px.svg' %}" />
    </span>
    <script>
    	$('.prev_item').on('click', function () {
    		 $('#item_loader').html('').load("{% url 'user_item' pk=object.get_previous_by_created.pk %}");
    	});
    </script>

   {% endif %}
   {% if object.get_next_by_created %}
    <span class="next_item">
      Позже
    </span>

    <script>
      $('.next_item').on('click', function () {
    		 $('#item_loader').html('').load("{% url 'user_item' pk=object.get_next_by_created.pk %}");
    	});
    </script>
    {% endif %}
</div>
<script>
  $('.activefullscreen_hide').on('click', function () {
  	 $('.activefullscreen').hide();
  	 $('#item_loader').empty();
  });
</script>
