{% load staticfiles %}
<script src="/static/scripts/cockie.js" type="text/javascript"></script>

<script>
$('.fullscreen').on('click', function () {
	 var item = $(this);
	 var article_id = item.parent().attr("article-id");
	 var post_id = item.parent().attr("post-id");
	 console.log(article_id,post_id);
	 if (article_id){
	 	$('#item_loader').html('').load("/article/detail/" + article_id + "?article=" + article_id)
 	 };
	 if (post_id){
	 	$('#item_loader').html('').load("/posts/detail/" + post_id + "?post=" + post_id)
 	 };
	 $('.activefullscreen').show();
});
$('.activefullscreen_hide').on('click', function () {
	 $('.activefullscreen').hide();
	 $('#item_loader').empty();
});
</script>
<script>
	$('.prev_article').on('click', function () {
		 var item = $(this);
		 var article_id = item.parent().attr("article-id");
		 var current = item.get_previous_by_created.uuid;
		 $('#item_loader').html('').load("/article/detail/" + current + "?article=" + article_id");

	});
</script>
<script>
	function art_like() {
			var like = $(this);
			var article = $('.infinite-item').attr("article-id");
			var type = like.data('type');
			var pk = like.data('id');
			var action  = like.data('action');
			var dislike = like.next().next();
			payload = {
					'article': article,
					'csrf_token': csrftoken
				}
			$.ajax({
					url: "/article/like/" + pk + "/",
					type: 'POST',
					cache: false,
					data: payload,
					success: function(data) {
							like.find("[data-count='like']").text(data.like_count);
							dislike.find("[data-count='dislike']").text(data.dislike_count);
							$(like).addClass("text-success");
							$(dislike).removeClass("text-danger");
							$(like).siblings('.like_window').html('').load("/article/like_window/" + pk + "/");
							$(dislike).siblings('.dislike_window').html('').load("/article/dislike_window/" + pk + "/")
					}
			});
			return false;
	}
	function art_dislike() {
			var dislike = $(this);
			var article = $('.infinite-item').attr("article-id");
			var type = dislike.data('type');
			var pk = dislike.data('id');
			var action = dislike.data('action');
			var like = dislike.prev().prev();
			payload = {
					'article': article,
					'csrf_token': csrftoken
				}
			$.ajax({
					url: "/article/dislike/" + pk + "/",
					type: 'POST',
					cache: false,
					data: payload,
					success: function(data) {
							dislike.find("[data-count='dislike']").text(data.dislike_count);
							like.find("[data-count='like']").text(data.like_count);
							$(dislike).addClass("text-danger");
							$(like).removeClass("text-success");
							$(like).siblings('.like_window').html('').load("/article/like_window/" + pk + "/");
							$(dislike).siblings('.dislike_window').html('').load("/article/dislike_window/" + pk + "/")
					}
			});
			return false;
	}
	// Подключение обработчиков
	$('[data-action="art_like"]').click(art_like);
	$('[data-action="art_dislike"]').click(art_dislike);
</script>

<script>
	function post_like() {
			var like = $(this);
			var post = $('.infinite-item').attr("post-id");
			var type = like.data('type');
			var pk = like.data('id');
			var action  = like.data('action');
			var dislike = like.next().next();
			payload = {
					'post': post,
					'csrf_token': csrftoken
				}
			$.ajax({
					url: "/posts/like/" + pk + "/",
					type: 'POST',
					cache: false,
					data: payload,
					success: function(data) {
							like.find("[data-count='like']").text(data.like_count);
							dislike.find("[data-count='dislike']").text(data.dislike_count);
							$(like).addClass("text-success");
							$(dislike).removeClass("text-danger");
							$(like).siblings('.like_window').html('').load("/posts/like_window/" + pk + "/");
							$(dislike).siblings('.dislike_window').html('').load("/posts/dislike_window/" + pk + "/")
					}
			});
			return false;
	}
	function post_dislike() {
			var dislike = $(this);
			var post = $('.infinite-item').attr("posts-id");
			var type = dislike.data('type');
			var pk = dislike.data('id');
			var action = dislike.data('action');
			var like = dislike.prev().prev();
			payload = {
					'post': post,
					'csrf_token': csrftoken
				}
			$.ajax({
					url: "/posts/dislike/" + pk + "/",
					type: 'POST',
					cache: false,
					data: payload,
					success: function(data) {
							dislike.find("[data-count='dislike']").text(data.dislike_count);
							like.find("[data-count='like']").text(data.like_count);
							$(dislike).addClass("text-danger");
							$(like).removeClass("text-success");
							$(like).siblings('.like_window').html('').load("/posts/like_window/" + pk + "/");
							$(dislike).siblings('.dislike_window').html('').load("/posts/dislike_window/" + pk + "/")
					}
			});
			return false;
	}
	// Подключение обработчиков
	$('[data-action="post_like"]').click(post_like);
	$('[data-action="post_dislike"]').click(post_dislike);
</script>


<script>
$(".art_comment").on("click", function () {
	var article = $(this).closest(".infinite-item").attr("article-id");
	var url = $(this).parents(".infinite-item");
	$.ajax({
			url: '{% url "article_get_comment" %}',
			data: {'article': article},
			cache: false,
			beforeSend: function () {
					url.find(".load_comments").html("<span style='display:flex;justify-content: center;'><img src='/static/images/loading.gif'></span>");
			},
			success: function (data) {
				url.find(".load_comments").html(data.comments);
			}
	});
	return false;
});
</script>
<script>
$(".post_comment").on("click", function () {
	var post = $(this).closest(".infinite-item").attr("post-id");
	var url = $(this).parents(".infinite-item");
	$.ajax({
			url: '{% url "post_get_comment" %}',
			data: {'post': post},
			cache: false,
			beforeSend: function () {
					url.find(".load_comments").html("<span style='display:flex;justify-content: center;'><img src='/static/images/loading.gif'></span>");
			},
			success: function (data) {
				url.find(".load_comments").html(data.comments);
			}
	});
	return false;
});
</script>

<script>
function new_message_popap(new_message) {
	if ($(".wrapper").length == 0){
		$(new_message).wrapInner("<div class='wrapper'></div>");
	}
	$(new_message).show();
	$(new_message).click(function(e) {
		if ( e.target == this ) {
			if ($(new_message).is(':visible')) {
				$(new_message).hide();
			}
		}
	});
	$(new_message).find("button[name=message_close]").on("click", function() {
		if ($(".formElementError").is(':visible')) {
			$(".formElementError").remove();
		}
		$(new_message).hide();
	});
}
$(document).ready(function () {
	$("[data-js=new_message]").on("click", function() {
		new_message_popap($(".new_message"));
	});
});
</script>

{% if user == request.user %}
<script>
function avatar_change_popap(avatar_change) {
	if ($(".wrapper").length == 0){
		$(avatar_change).wrapInner("<div class='wrapper'></div>");
	}
	$(avatar_change).show();
	$(avatar_change).click(function(e) {
		if ( e.target == this ) {
			if ($(avatar_change).is(':visible')) {
				$(avatar_change).hide();
			}
		}
	});
	$(avatar_change).find("button[name=avatar_close]").on("click", function() {
		if ($(".formElementError").is(':visible')) {
			$(".formElementError").remove();
		}
		$(avatar_change).hide();
	});
}
$(document).ready(function () {
	$("[data-js=avatar_change]").on("click", function() {
		avatar_change_popap($(".avatar_change"));
	});
});
</script>


<script type="text/javascript">
    var frm = $('#FORM-POST');
    frm.submit(function () {
        $.ajax({
            type: frm.attr('method'),
            url: "{% url 'post_add_user' %}",
            data: frm.serialize(),
            success: function (data) {
              $(".stream").prepend(data);
              $(".id_text").val("");
              $.toast({
                  heading: '{{ request.user.first_name }}',
                  text: 'Запись успешно создана!',
                  showHideTransition: 'fade',
                  icon: 'success'
              })
            },
            error: function(data) {
                $("#hack").html("Возникла непредвидинная ошибка!!");
            }
        });
        return false;
    });
</script>

<script>
	$( "#article_hard" ).click(function(){
		$('#article_create').html('').load("/article/add_hard/");
	})
	$( "#article_medium" ).click(function(){
		$('#article_create').html('').load("/article/add_medium/");
	})
	$( "#article_lite" ).click(function(){
		$('#article_create').html('').load("/article/add_lite/");
	});
</script>
<script>
function remove() {
var remove = $(this);
var pk = remove.data('id');
$.ajax({
	url: "/posts/delete/" + pk + "/",
	success: function (data) {
		$(remove).parents('.card').hide();
		$.toast({
				heading: '{{ request.user.first_name }}',
				text: 'Запись успешно удалена!',
				showHideTransition: 'fade',
				icon: 'error'
		})
	},
	error: function(data) {
	}
});
};
$('[data-action="post_remove"]').click(remove);
</script>
<script>
function remove() {
var remove = $(this);
var pk = remove.data('id');
$.ajax({
	url: "/article/delete/" + pk + "/",
	success: function (data) {
		$(remove).parents('.card').hide();
		$.toast({
				heading: '{{ request.user.first_name }}',
				text: 'статья успешно удалена!',
				showHideTransition: 'fade',
				icon: 'error'
		})
	},
	error: function(data) {
	}
});
};
$('[data-action="article_remove"]').click(remove);
</script>

<script src="/static/scripts/cropper.min.js" type="text/javascript"></script>

<script>
  class Uploader {
    constructor(options) {
      if (!options.input) {
        throw '[Uploader] Missing input file element.';
      }
      this.fileInput = options.input;
      this.types = options.types || ['gif', 'jpg', 'jpeg', 'png'];
    }
    listen(resolve, reject) {
      this.fileInput.onchange = e => {
        e.preventDefault();
        if (!this.fileInput.files || this.fileInput.files.length !== 1) {
          reject('[Uploader:listen] Select only one file.');
        }
        let file = this.fileInput.files[0];
        let reader = new FileReader();
        // Make sure the file is of the correct type
        if (!this.validFileType(file.type)) {
          reject(`[Uploader:listen] Invalid file type: ${file.type}`);
        } else {
          reader.readAsDataURL(file);
          reader.onload = e => resolve(e.target.result);
        }
      };
    }
    /** @private */
    validFileType(filename) {
      let extension = filename.split('/').pop().toLowerCase();
      return this.types.includes(extension);
    }}
  function squareContains(square, coordinate) {
    return coordinate.x >= square.pos.x &&
    coordinate.x <= square.pos.x + square.size.x &&
    coordinate.y >= square.pos.y &&
    coordinate.y <= square.pos.y + square.size.y;
  }
  class Cropper {
    constructor(options) {
      if (!options.size) {throw 'Size field in options is required';}
      if (!options.canvas) {throw 'Could not find image canvas element.';}
      if (!options.preview) {throw 'Could not find preview canvas element.';}
      this.imageCanvas = options.canvas;
      this.previewCanvas = options.preview;
      this.c = this.imageCanvas.getContext("2d");
      this.limit = options.limit || 500; // default to 600px
      this.crop = {
        size: { x: options.size.width, y: options.size.height },
        pos: { x: 0, y: 0 },
        handleSize: 10 };
      this.previewCanvas.width = options.size.width;
      this.previewCanvas.height = options.size.height;
      this.boundDrag = this.drag.bind(this);
      this.boundClickStop = this.clickStop.bind(this);
      this.boundTouchtest = this.touchtest.bind(this);
    }
    setImageSource(source) {
      this.image = new Image();
      this.image.src = source;
      this.image.onload = e => {
        this.render();
        // Listen for events on the canvas when the image is ready
        this.imageCanvas.onmousedown = this.clickStart.bind(this);
        this.imageCanvas.ontouchmove = this.clickStart.bind(this);
      };
    }
    export(img) {
      img.setAttribute('src', this.previewCanvas.toDataURL());
    }
    /** @private */
    render() {
      this.c.clearRect(0, 0, this.imageCanvas.width, this.imageCanvas.height);
      this.displayImage();
      this.preview();
      this.drawCropWindow();
    }
    /** @private */
    clickStart(e) {
      const position = { x: e.offsetX, y: e.offsetY };
      this.lastEvent = {
        position: position,
        resizing: this.isResizing(position),
        moving: this.isMoving(position) };
      this.imageCanvas.addEventListener("touchmove", this.boundTouchtest);
      this.imageCanvas.addEventListener('mousemove', this.boundDrag);
      this.imageCanvas.addEventListener('mouseup', this.boundClickStop);
    }
    /** @private */
    clickStop(e) {
      this.imageCanvas.removeEventListener("mousemove", this.boundDrag);
      this.imageCanvas.removeEventListener("mouseup", this.boundClickStop);
    }
    isResizing(coord) {
      const size = this.crop.handleSize;
      const handle = {
        pos: {
          x: this.crop.pos.x + this.crop.size.x - size / 2,
          y: this.crop.pos.y + this.crop.size.y - size / 2 },
        size: { x: size, y: size } };
      return squareContains(handle, coord);
    }
    /** @private */
    isMoving(coord) {
      return squareContains(this.crop, coord);
    }
    touchtest(e) {
      const position = {
        x: e.targetTouches[0].pageX - e.target.getBoundingClientRect().left,
        y: e.targetTouches[0].pageY - e.target.getBoundingClientRect().top };
      const dx = position.x - this.lastEvent.position.x;
      const dy = position.y - this.lastEvent.position.y;
      if (this.lastEvent.resizing) {
        this.resize(dx, dy);
      } else if (this.lastEvent.moving) {
        this.move(dx, dy);
      }
      this.lastEvent.position = position;
      this.render();
    }
    /** @private */
    drag(e) {
      const position = {
        x: e.offsetX,
        y: e.offsetY };
      const dx = position.x - this.lastEvent.position.x;
      const dy = position.y - this.lastEvent.position.y;
      if (this.lastEvent.resizing) {
        this.resize(dx, dy);
      } else if (this.lastEvent.moving) {
        this.move(dx, dy);
      }
      this.lastEvent.position = position;
      this.render();
    }
    /** @private */
    resize(dx, dy) {
      let handle = {
        x: this.crop.pos.x + this.crop.size.x,
        y: this.crop.pos.y + this.crop.size.y };
      const amount = Math.abs(dx) > Math.abs(dy) ? dx : dy;
      if (this.inBounds(handle.x + amount, handle.y + amount)) {
        this.crop.size.x += amount;
        this.crop.size.y += amount;
      }
    }
    /** @private */
    move(dx, dy) {
      const tl = {
        x: this.crop.pos.x,
        y: this.crop.pos.y };
      const br = {
        x: this.crop.pos.x + this.crop.size.x,
        y: this.crop.pos.y + this.crop.size.y };
      if (this.inBounds(tl.x + dx, tl.y + dy) &&
      this.inBounds(br.x + dx, tl.y + dy) &&
      this.inBounds(br.x + dx, br.y + dy) &&
      this.inBounds(tl.x + dx, br.y + dy)) {
        this.crop.pos.x += dx;
        this.crop.pos.y += dy;
      }
    }
    /** @private */
    displayImage() {
      const ratio = this.limit / Math.max(this.image.width, this.image.height);
      this.image.width *= ratio;
      this.image.height *= ratio;
      this.imageCanvas.width = this.image.width;
      this.imageCanvas.height = this.image.height;
      this.c.drawImage(this.image, 0, 0, this.image.width, this.image.height);
    }
    /** @private */
    drawCropWindow() {
      const pos = this.crop.pos;
      const size = this.crop.size;
      const radius = this.crop.handleSize / 2;
      this.c.strokeStyle = 'blue';
      this.c.fillStyle = 'blue';
      this.c.strokeRect(pos.x, pos.y, size.x, size.y);
      const path = new Path2D();
      path.arc(pos.x + size.x, pos.y + size.y, radius, 0, Math.PI * 2, true);
      this.c.fill(path);
    }
    /** @private */
    preview() {
      const pos = this.crop.pos;
      const size = this.crop.size;
      const imageData = this.c.getImageData(pos.x, pos.y, size.x, size.y);
      if (!imageData) {
        return false;
      }
      const ctx = this.previewCanvas.getContext('2d');
      ctx.clearRect(0, 0, this.previewCanvas.width, this.previewCanvas.height);
      ctx.drawImage(this.imageCanvas,
      pos.x, pos.y,
      size.x, size.y,
      0, 0,
      this.previewCanvas.width, this.previewCanvas.height);
    }
    /** @private */
    inBounds(x, y) {
      return squareContains({
        pos: { x: 0, y: 0 },
        size: {
          x: this.imageCanvas.width,
          y: this.imageCanvas.height } },
      { x: x, y: y });
    }}
  function exceptionHandler(message) {
    console.log(message);
  }
  var dimensions = { width: 250, height: 250 };
  try {
    var uploader = new Uploader({
      input: document.querySelector('.js-fileinput'),
      types: ['gif', 'jpg', 'jpeg', 'png'] });
    var editor = new Cropper({
      size: dimensions,
      canvas: document.querySelector('.js-editorcanvas'),
      preview: document.querySelector('.js-previewcanvas') });
    if (uploader && editor) {
      uploader.listen(editor.setImageSource.bind(editor), error => {throw error;});
    }
    var img = document.createElement('img');
    $('#AVATAR-FORM').append(img);
    document.querySelector('.js-export').onclick = e => editor.export(img);
    var frm10 = $('#AVATAR-FORM');
    frm10.submit(function () {
        $.ajax({
            type: frm10.attr('method'),
            url: "{% url 'user_avatar_form' pk=request.user.pk %}",
            data: new FormData($('form')[0]),
            contentType: false,
            cache: false,
            processData:false,
            success: function (data) {
              console.log("Все ОК")
            },
            error: function(data) {
                console.log("Все не ОК")
            }
        });
        return false;
    });
  } catch (error) {
    exceptionHandler(error.message);
  }
  $('.left').on('click', function () {
    alert(editor.previewCanvas.width);
    editor.getContext("2d").move(10, 10);
  });
  $('.right').click(function (event) {
  });
  function myFunction(event) {
    var x = event.touches[0].clientX;
    var y = event.touches[0].clientY;
    document.getElementById("demo").innerHTML = x + ", " + y;
  }
</script>

{% endif %}
