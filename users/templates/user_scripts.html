{% load staticfiles %}

<script src="/static/scripts/cockie.js" type="text/javascript"></script>

{% if user == request.user %}
<script>
  $( "#post_hard" ).click(function(){
    $('#post_create').html('').load("{% url 'post_add_hard_user' %}");
  })
</script>
<script>
  $( "#post_medium" ).click(function(){
    $('#post_create').html('').load("{% url 'post_add_medium_user' %}");
  })
</script>
<script>
  $( "#post_lite" ).click(function(){
    $('#post_create').html('').load("{% url 'post_add_lite_user' %}");
  });
</script>
{% endif %}

<script>
    function like() {
        var like = $(this);
        var type = like.data('type');
        var pk = like.data('id');
        var action  = like.data('action');
        var dislike = like.next();
        $.ajax({
            url: "/posts/like/" + pk + "/",
            type: 'POST',
            data: {
                'obj': pk
            },
            success: function(json) {
                like.find("[data-count='like']").text(json.like_count);
                dislike.find("[data-count='dislike']").text(json.dislike_count);
                $(".like").addClass("text-success");
                $(".dislike").removeClass("text-danger");
            }
        });
        return false;
    }
    function dislike() {
        var dislike = $(this);
        var type = dislike.data('type');
        var pk = dislike.data('id');
        var action = dislike.data('action');
        var like = dislike.prev();
        $.ajax({
            url: "/posts/dislike/" + pk + "/",
            type: 'POST',
            data: {
                'obj': pk
            },
            success: function(json) {
                dislike.find("[data-count='dislike']").text(json.dislike_count);
                like.find("[data-count='like']").text(json.like_count);
                $(".dislike").addClass("text-danger");
                $(".like").removeClass("text-success");
            }
        });
        return false;
    }
    // Подключение обработчиков
    $('[data-action="like"]').click(like);
    $('[data-action="dislike"]').click(dislike);
</script>

<script>
function avatar_change_popap(avatar_change) {

	if ($(".wrapper").length == 0){
		$(avatar_change).wrapInner("<div class='wrapper'></div>");
	}
	$(avatar_change).show();

	$(avatar_change).click(function(e) {
		if ( e.target == this ) {
			if ($(avatar_change).is(':visible')) {
				$(avatar_change).hide();
			}
		}
	});

	$(avatar_change).find("button[name=avatar_close]").on("click", function() {
		if ($(".formElementError").is(':visible')) {
			$(".formElementError").remove();
		}
		$(avatar_change).hide();
	});
}

$(document).ready(function () {
	$("[data-js=avatar_change]").on("click", function() {
		avatar_change_popap($(".avatar_change"));
	});
});
</script>

<script src="/static/scripts/cropper.min.js" type="text/javascript"></script>

<script>
  // vars
let result = document.querySelector('.result'),
img_result = document.querySelector('.img-result'),
img_w = document.querySelector('.img-w'),
img_h = document.querySelector('.img-h'),
options = document.querySelector('.options'),
save = document.querySelector('.save'),
cropped = document.querySelector('.cropped'),
dwn = document.querySelector('.download'),
upload = document.querySelector('#file-input'),
cropper = '';

// on change show image with crop options
upload.addEventListener('change', e => {
  if (e.target.files.length) {
    // start file reader
    const reader = new FileReader();
    reader.onload = e => {
      if (e.target.result) {
        // create new image
        let img = document.createElement('img');
        img.id = 'image';
        img.src = e.target.result;
        // clean result before
        result.innerHTML = '';
        // append new image
        result.appendChild(img);
        // show save btn and options
        save.classList.remove('hide');
        options.classList.remove('hide');
        // init cropper
        cropper = new Cropper(img);
      }
    };
    reader.readAsDataURL(e.target.files[0]);
  }
});

// save on click
save.addEventListener('click', e => {
  e.preventDefault();
  // get result to data uri
  let imgSrc = cropper.getCroppedCanvas({
    width: img_w.value // input value
  }).toDataURL();
  // remove hide class of img
  cropped.classList.remove('hide');
  img_result.classList.remove('hide');
  // show image cropped
  cropped.src = imgSrc;
  dwn.classList.remove('hide');
  dwn.download = 'imagename.png';
  dwn.setAttribute('href', imgSrc);
});
</script>
