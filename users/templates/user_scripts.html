{% load staticfiles %}

<script src="/static/scripts/cockie.js" type="text/javascript"></script>

{% if user == request.user %}
<script>
  $( "#post_hard" ).click(function(){
    $('#post_create').html('').load("{% url 'post_add_hard_user' %}");
  })
</script>
<script>
  $( "#post_medium" ).click(function(){
    $('#post_create').html('').load("{% url 'post_add_medium_user' %}");
  })
</script>
<script>
  $( "#post_lite" ).click(function(){
    $('#post_create').html('').load("{% url 'post_add_lite_user' %}");
  });
</script>
{% endif %}

<script>
    function like() {
        var like = $(this);
        var type = like.data('type');
        var pk = like.data('id');
        var action  = like.data('action');
        var dislike = like.next();
        $.ajax({
            url: "/posts/like/" + pk + "/",
            type: 'POST',
            data: {
                'obj': pk
            },
            success: function(json) {
                like.find("[data-count='like']").text(json.like_count);
                dislike.find("[data-count='dislike']").text(json.dislike_count);
                $(".like").addClass("text-success");
                $(".dislike").removeClass("text-danger");
            }
        });
        return false;
    }
    function dislike() {
        var dislike = $(this);
        var type = dislike.data('type');
        var pk = dislike.data('id');
        var action = dislike.data('action');
        var like = dislike.prev();
        $.ajax({
            url: "/posts/dislike/" + pk + "/",
            type: 'POST',
            data: {
                'obj': pk
            },
            success: function(json) {
                dislike.find("[data-count='dislike']").text(json.dislike_count);
                like.find("[data-count='like']").text(json.like_count);
                $(".dislike").addClass("text-danger");
                $(".like").removeClass("text-success");
            }
        });
        return false;
    }
    // Подключение обработчиков
    $('[data-action="like"]').click(like);
    $('[data-action="dislike"]').click(dislike);
</script>

<script>
function avatar_change_popap(avatar_change) {

	if ($(".wrapper").length == 0){
		$(avatar_change).wrapInner("<div class='wrapper'></div>");
	}
	$(avatar_change).show();

	$(avatar_change).click(function(e) {
		if ( e.target == this ) {
			if ($(avatar_change).is(':visible')) {
				$(avatar_change).hide();
			}
		}
	});

	$(avatar_change).find("button[name=avatar_close]").on("click", function() {
		if ($(".formElementError").is(':visible')) {
			$(".formElementError").remove();
		}
		$(avatar_change).hide();
	});
}

$(document).ready(function () {
	$("[data-js=avatar_change]").on("click", function() {
		avatar_change_popap($(".avatar_change"));
	});
});
</script>

<script src="/static/scripts/cropper.min.js" type="text/javascript"></script>

<script>
  class Uploader {
    constructor(options) {
      if (!options.input) {
        throw '[Uploader] Missing input file element.';
      }
      this.fileInput = options.input;
      this.types = options.types || ['gif', 'jpg', 'jpeg', 'png'];
    }

    listen(resolve, reject) {
      this.fileInput.onchange = e => {
        e.preventDefault();

        if (!this.fileInput.files || this.fileInput.files.length !== 1) {
          reject('[Uploader:listen] Select only one file.');
        }

        let file = this.fileInput.files[0];
        let reader = new FileReader();

        if (!this.validFileType(file.type)) {
          reject(`[Uploader:listen] Invalid file type: ${file.type}`);
        } else {
          reader.readAsDataURL(file);
          reader.onload = e => resolve(e.target.result);
        }
      };
    }


  function squareContains(square, coordinate) {
    return coordinate.x >= square.pos.x &&
    coordinate.x <= square.pos.x + square.size.x &&
    coordinate.y >= square.pos.y &&
    coordinate.y <= square.pos.y + square.size.y;
  }

  class Cropper {
    constructor(options) {
      if (!options.size) {throw 'Size field in options is required';}
      if (!options.canvas) {throw 'Could not find image canvas element.';}
      if (!options.preview) {throw 'Could not find preview canvas element.';}

      this.imageCanvas = options.canvas;
      this.previewCanvas = options.preview;
      this.c = this.imageCanvas.getContext("2d");

      this.limit = options.limit || 500; // default to 600px

      this.crop = {
        size: { x: options.size.width, y: options.size.height },
        pos: { x: 0, y: 0 },
        handleSize: 10 };

      this.previewCanvas.width = options.size.width;
      this.previewCanvas.height = options.size.height;

      this.boundDrag = this.drag.bind(this);
      this.boundClickStop = this.clickStop.bind(this);
      this.boundTouchtest = this.touchtest.bind(this);
    }

    setImageSource(source) {
      this.image = new Image();
      this.image.src = source;
      this.image.onload = e => {
        this.render();
        // Listen for events on the canvas when the image is ready
        this.imageCanvas.onmousedown = this.clickStart.bind(this);
        this.imageCanvas.ontouchmove = this.clickStart.bind(this);
      };
    }

    export(img) {
      img.setAttribute('src', this.previewCanvas.toDataURL());
    }


    isResizing(coord) {
      const size = this.crop.handleSize;
      const handle = {
        pos: {
          x: this.crop.pos.x + this.crop.size.x - size / 2,
          y: this.crop.pos.y + this.crop.size.y - size / 2 },

        size: { x: size, y: size } };
      return squareContains(handle, coord);
    }

    touchtest(e) {
      const position = {
        x: e.targetTouches[0].pageX - e.target.getBoundingClientRect().left,
        y: e.targetTouches[0].pageY - e.target.getBoundingClientRect().top };


      const dx = position.x - this.lastEvent.position.x;
      const dy = position.y - this.lastEvent.position.y;
      if (this.lastEvent.resizing) {
        this.resize(dx, dy);
      } else if (this.lastEvent.moving) {
        this.move(dx, dy);
      }
      this.lastEvent.position = position;
      this.render();
    }


    preview() {
      const pos = this.crop.pos;
      const size = this.crop.size;
      const imageData = this.c.getImageData(pos.x, pos.y, size.x, size.y);
      if (!imageData) {
        return false;
      }
      const ctx = this.previewCanvas.getContext('2d');
      ctx.clearRect(0, 0, this.previewCanvas.width, this.previewCanvas.height);
      ctx.drawImage(this.imageCanvas,
      pos.x, pos.y,
      size.x, size.y,
      0, 0,
      this.previewCanvas.width, this.previewCanvas.height);
    }

  function exceptionHandler(message) {
    console.log(message);
  }

  var dimensions = { width: 250, height: 250 };

  try {
    var uploader = new Uploader({
      input: document.querySelector('.js-fileinput'),
      types: ['gif', 'jpg', 'jpeg', 'png'] });


    var editor = new Cropper({
      size: dimensions,
      canvas: document.querySelector('.js-editorcanvas'),
      preview: document.querySelector('.js-previewcanvas') });


    if (uploader && editor) {
      uploader.listen(editor.setImageSource.bind(editor), error => {throw error;});
    }
    var img = document.createElement('img');
    document.body.appendChild(img);
    document.querySelector('.js-export').onclick = e => editor.export(img);

  } catch (error) {
    exceptionHandler(error.message);
  }

  $('.left').on('click', function () {
    alert(editor.previewCanvas.width);
    editor.getContext("2d").move(10, 10);
  });
  $('.right').click(function (event) {

  });

  function myFunction(event) {
    var x = event.touches[0].clientX;
    var y = event.touches[0].clientY;
    document.getElementById("demo").innerHTML = x + ", " + y;
  }
</script>
