{% extends "base.html" %}
{% load staticfiles humanize %}

{% block title %}{{ user.get_full_name }}{% endblock %}
{% block meta %}
<meta property="og:url" content="dvizhenie.tv" />
<meta property="og:type" content="website" />
<meta property="og:title" content="" />
<meta property="og:image" content="{% if user.profile.avatar %}http://xn--b1afgj5al1e.xn--p1acf/{{ user.profile.avatar }}{% else %}{% static 'images/user.png' %}{% endif %}"/>
{% endblock %}
{% block content %}

<div class="row user_page">
    <div class="col-lg-4 col-md-5 col-sm-12 order-1">

        {% include 'profile/card_profile.html' %}

        {% include 'profile/common_frends.html' %}

        {% include 'profile/online_frends.html' %}

        {% include 'profile/frends.html' %}

        {% include 'profile/communities.html' %}

        {% include 'profile/gallery.html' %}

    </div>
    <div class="col-lg-8 col-md-7 col-sm-12 order-2 ">
        <div class="card mb-4" style="padding:10px">
            <h3 class="mb-0">{{ user.get_full_name }}</h3>
            {% if user.get_online %}
              <i class="text-success">Онлайн</i>
            {% else %}
              <i style="color:#888888">Был(а) {{ user.last_activity|naturaltime }}</i>
            {% endif %}
            <br><br>
        </div>

          <div id="stat_load"></div>

          {% include 'profile/new_post.html' %}

          <div id="lenta_load"></div>

        </div>
    </div>

<script>
ready(() => {
  var link = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject( 'Microsoft.XMLHTTP' );
  link.open( 'GET', '/users/detail/list/' + '{{ user.pk }}', true );
  link.onreadystatechange = function () {
    if ( link.readyState == 4 ) {
        if ( link.status == 200 ) {
            var lenta_load = document.getElementById("lenta_load");
            lenta_load.innerHTML = link.responseText;
        }
    }
};
link.send( null );

$("body").on('click', '.u_like', function() {
  like = $(this);
  item = like.parents('.infinite-item');
  pk = item.attr("user-id");
  uuid = item.attr("item-id");
  dislike = like.next().next();
  $.ajax({
    url: "/votes/user_like/" + uuid + "/" + pk + "/",
    type: 'POST',
    data: {'obj': pk},
    success: function(json){
      like.find("[data-count='like']").text(json.like_count);
      like.toggleClass('btn_success btn_default');
      like.next().html('').load("/window/u_like_window/" + uuid + "/" + pk + "/");
      dislike.find("[data-count='dislike']").text(json.dislike_count);
      dislike.removeClass('btn_danger').addClass("btn_default");
      dislike.next().html('').load("/window/u_dislike_window/" + uuid + "/" + pk + "/")}});
      return false;
    });
$("body").on('click', '.u_dislike', function() {
  dislike = $(this);
  item = dislike.parents('.infinite-item');
  pk = item.attr("user-id");
  uuid = item.attr("item-id");
  like = dislike.prev().prev();
  $.ajax({
    url: "/votes/user_dislike/" + uuid + "/" + pk + "/",
    type: 'POST',
    data: {'obj': pk},
    success: function(json) {
      like.find("[data-count='like']").text(json.like_count);
      like.removeClass('btn_success').addClass("btn_default");
      like.next().html('').load("/window/u_like_window/" + uuid + "/" + pk + "/");
      dislike.find("[data-count='dislike']").text(json.dislike_count);
      dislike.toggleClass('btn_danger btn_default');
      dislike.next().html('').load("/window/u_dislike_window/" + uuid + "/" + pk + "/")}
    });
    return false;
  });

$("body").on('click', '.u_like2', function() {like = $(this);pk = like.data('pk');uuid = like.data('uuid');dislike = like.next().next();$.ajax({url: "/votes/user_comment/" + uuid + "/" + pk + "/like/", type: 'POST', data: {'obj': pk},success: function(json) {like.find("[data-count='like']").text(json.like_count); like.toggleClass('btn_success btn_default'); like.next().html('').load("/window/u_comment_like_window/" + uuid + "/" + pk + "/");dislike.find("[data-count='dislike']").text(json.dislike_count); dislike.removeClass('btn_danger').addClass("btn_default"); dislike.next().html('').load("/window/u_comment_dislike_window/" + uuid + "/" + pk + "/")}});return false;});
$("body").on('click', '.u_dislike2', function() {dislike = $(this);pk = dislike.data('pk');uuid = dislike.data('uuid');like = dislike.prev().prev();$.ajax({url: "/votes/user_comment/" + uuid + "/" + pk + "/dislike/", type: 'POST', data: {'obj': pk},success: function(json) {like.find("[data-count='like']").text(json.like_count); like.removeClass('btn_success').addClass("btn_default"); like.next().html('').load("/window/u_comment_like_window/" + uuid + "/" + pk + "/");dislike.find("[data-count='dislike']").text(json.dislike_count); dislike.toggleClass('btn_danger btn_default'); dislike.next().html('').load("/window/u_comment_dislike_window/" + uuid + "/" + pk + "/")}});return false;});

});

var page = 2;
var loaded = false;
onscroll = function(){
  try{
  var items = document.getElementById("lenta_container");

  if(items.getElementsByClassName('infinite-item').length === (page-1)*30){
  var height = document.documentElement.clientHeight-1;
  if(window.scrollY+1 >= document.documentElement.scrollHeight-height){
    if (loaded){return};
    var link_3 = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject( 'Microsoft.XMLHTTP' );
    link_3.open( 'GET', '/users/detail/list/{{ user.pk }}/?page=' + page++, true );
    link_3.send();
    link_3.onreadystatechange = function () {
    if ( this.readyState == 4 && this.status == 200 ) {
      var elem = document.createElement('span');
      elem.innerHTML = link_3.responseText;
      items_list = elem.querySelector(".stream");
      if(items_list.getElementsByClassName('infinite-item').length === 30){loaded = true;};
      items.append(items_list);
      }
    }
  }}
}catch{return}
};

</script>

{% endblock %}
