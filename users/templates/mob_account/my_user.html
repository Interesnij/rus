{% extends "base_mobile.html" %}
{% load liked_user humanize thumbnail %}

{% block title %}{{ user.get_full_name }}{% endblock %}
{% block meta %}
<meta property="og:url" content="dvizhenie.tv" />
<meta property="og:type" content="website" />
<meta property="og:title" content="" />
<meta property="og:image" content="{% if user.profile.avatar %}http://xn--b1afgj5al1e.xn--p1acf/{{ user.profile.avatar }}{% else %}/static/images/user.png{% endif %}"/>
{% endblock %}
{% block content %}
<div class="container main-container">
<div class="row user_page">
    <div class="col-sm-12">
      <div class="card mb-4">
          <span style="margin:10px">
            <h3 class="mb-0">{{ user.get_full_name }}</h3>
            {% if user.get_online %}
              <i class="text-success">Онлайн</i>
            {% else %}
              <i style="color:#888888">Был(а) {{ user.last_activity|naturaltime }}</i>
            {% endif %}
          </span>
          <div class="card-body">
              <div class="row align-items-center no-gutters">
                  <a class="col">
                      <figure class="mx-auto mb-3" id="avatar_reload">
                        {% if user.get_avatar %}
                          <img src="{{ user.get_avatar.file.url }}" class="avatar_detail" style="cursor:pointer" data-uuid="{{ user.uuid }}" data-id="{{ user.get_avatar.id }}">
                        {% else %}
                          <svg fill="currentColor" class="svg_default" style="width:100%;height: auto;"xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/><path d="M0 0h24v24H0z" fill="none"/></svg>
                        {% endif %}
                      </figure>
                  </a>
              </div>

              <span style="display: flex;align-items: center;justify-content: center;margin-bottom: 10px;">
                  <div class="btn-group">
                      <button type="button" class="btn btn-sm btn-secondary" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                          Редактировать
                      </button>
                      <div class="dropdown-menu" x-placement="bottom-start">
                          <a class="dropdown-item" data-js="avatar_change" href="#">Аватар</a>
                          <a class="dropdown-item ajax" href="{% url 'user_general_form' request.user.pk %}" data-html="#ajax">Мои контакты</a>
                          <a class="dropdown-item ajax" href="{% url 'user_about_form' request.user.pk %}" data-html="#ajax">Обо мне</a>
                          <a class="dropdown-item ajax" href="{% url 'user_design' request.user.pk %}" data-html="#ajax">Внешний вид</a>
                      </div>
                  </div>
              </span>
              <span style="display: flex;align-items: center;justify-content: center;">
              <div class="btn-group">
                  <button type="button" class="btn btn-sm btn-secondary" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                      Настройки
                  </button>
                  <div class="dropdown-menu" x-placement="bottom-start">
                      <a class="dropdown-item ajax" href="{% url 'user_settings_private' user.pk %}" data-html="#ajax">Приватность</a>
                      <a class="dropdown-item ajax" href="{% url 'user_settings_notify' user.pk %}" data-html="#ajax">Уведомления</a>
                  </div>
              </div>
              </span>
          </div>
      </div>
      {% if user.get_pop_connection %}
      <div class="card mb-4  ">
          <div class="card-header">
              <div class="media">
                  <div class="icon-circle icon-30 bg-light-danger mr-3">
                      <i class="material-icons">notifications</i>
                  </div>
                  <div class="media-body">
                      <h5 class="mt-1">Reminder</h5>
                  </div>
              </div>
          </div>
          <div class="card-body py-2">
              <div class="media">
                {% for object in user.get_pop_connection %}
                  <figure style="width:50px;" class="avatar-50 staked">
                    {% if object.get_avatar %}
                    <img src="{{ object.get_avatar.file|thumbnail_url:'avatar' }}" style="border-radius:50px;" alt="image">
                    {% else %}
                    <svg fill="currentColor" class="svg_default svg_default_50" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/><path d="M0 0h24v24H0z" fill="none"/></svg>
                    {% endif %}
                  </figure>
                {% endfor %}
                  <div class="media-body">
                    <h6 class="my-0 text-truncated">{{ user.count_connections }} {{ user.count_connections|rupluralize:"друг,друга,друзей" }}</h6>
                    <p class="small">{{ online_frends.count }} онлайн</p>
                  </div>
              </div>
          </div>
          </div>
          {% else %}
          <div class="card mb-4">
              <div class="card-header">
                  <div class="media" style="display: flex;align-items: center;justify-content: center;">
                      <a href="{% url 'all_users' %}" class="ajax" data-html="#ajax">
                          <div class="media-body">
                              <h4 class="content-color-primary mb-0">Найдите друзей </h4>
                          </div>
                      </a>
                  </div>
              </div>
          </div>
          {% endif %}


      {% include 'profile/communities.html' %}

      {% include 'profile/gallery.html' %}
    </div>
    <div class="col-sm-12">

        <div id="stat_load"></div>

        {% include 'profile/new_post.html' %}

        <div id="lenta_load"></div>

    </div>
</div>
</div>
<script>
ready(() => {
  icon_5 = document.querySelector(".icon_v5");
  tip = document.querySelector(".selected-tip");
  updateSelected(icon_5);

  var link = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject( 'Microsoft.XMLHTTP' );
  link.open( 'GET', '/users/detail/list/' + '{{ user.pk }}', true );
  link.onreadystatechange = function () {
    if ( link.readyState == 4 ) {
        if ( link.status == 200 ) {
            var lenta_load = document.getElementById("lenta_load");
            lenta_load.innerHTML = link.responseText;
        }
    }
};
link.send( null );
});

var page = 2;
var loaded = false;
onscroll = function(){
  try{
  var items = document.getElementById("lenta_container");

  if(items.getElementsByClassName('infinite-item').length === (page-1)*30){
  var height = document.documentElement.clientHeight-1;
  if(window.scrollY+1 >= document.documentElement.scrollHeight-height){
    if (loaded){return};
    var link_3 = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject( 'Microsoft.XMLHTTP' );
    link_3.open( 'GET', '/users/detail/list/{{ user.pk }/?page=' + page++, true );
    link_3.send();
    link_3.onreadystatechange = function () {
    if ( this.readyState == 4 && this.status == 200 ) {
      var elem = document.createElement('span');
      elem.innerHTML = link_3.responseText;
      items_list = elem.querySelector(".stream");
      if(items_list.getElementsByClassName('infinite-item').length < 30){loaded = true;};
      items.append(items_list);
      }
    }
  }}
}catch{return}
}

</script>

{% endblock %}
